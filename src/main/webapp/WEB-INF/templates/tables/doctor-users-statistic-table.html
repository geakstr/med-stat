<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="table">

<style>
.demo-container {
  box-sizing: border-box;
  width: 850px;
  height: 450px;
}

.demo-placeholder {
  width: 100%;
  height: 100%;
  font-size: 14px;
  line-height: 1.2em;
}
</style>

<input type="hidden" id="userIdHidden" th:value="${userId}" />

<table class="table-hover" style="width: 48%; float: left;">
    <thead>
	    <tr>
	        <th>Имя</th>
	        <th>
            <select id="gyms-select">
              <option value="-1">Упражнения</option>
              <option th:each="gym : ${userGyms}" th:text="${gym.title}" th:value="${gym.id}" th:selected="${gym.id} == ${gymId}"></option>
            </select>
          </th>
	        <th>Прогресс</th>
	        <th>Дата</th>
	    </tr>
    </thead>
    <tbody>
	    <tr th:each="s:${userStats}">
	        <td th:text="${s.userGym.user.lastName} + ', ' + ${s.userGym.user.firstName}"></td>
	        <td th:text="${s.userGym.gymnastic.title}"></td>
	        <td th:text="${s.percent}" style="width: 1px; text-align: right;"></td>
	        <td th:text="${#dates.format(s.date, 'dd/MM/yyyy')}" style="width: 1px;"></td>
	    </tr>
    </tbody>
</table>

<div style="clear: both;"></div>
<div class="demo-container">
  <div id="placeholder" class="demo-placeholder"></div>
</div>

</div>

<div th:fragment="scripts">
<script th:inline="javascript">
/*<![CDATA[*/
$(document).ready(function() {
  var $gymsSelect = $("#gyms-select");
  $gymsSelect.change(function() {
    var gymId = parseInt($(this).val());
    if (gymId === -1) {
        window.location.href = "http://localhost:8080/lk/user";
    } else {
        window.location.href = "http://localhost:8080/lk/user/gym/" + gymId;
    }
    return true;
  });

  var userId = $("#userIdHidden").val();

  $.ajax({
    dataType: "json",
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    url: "/api/statistics/user/" + userId,
    success: function(data){
      console.log(data);
      var all_data = [
        { label: "Gym 1", data: [["2010/10/01", 0], ["2010/10/5", 1],
                 ["2010/10/10", 7], ["2010/10/15", 8]]},
        { label: "Gym 2", data: [["2010/10/01", 13], ["2010/10/5", 23],
                 ["2010/10/10", 32], ["2010/10/15", 33]]}
      ];

      for (var i = 0; i < data.length; i++) {
        for (var j = 0; j < data.[i].stats.stats.length; j++) {
          all_data.push({
            label : data[i].stats.stats[j].gym_title,

          });
        }
      }

      // преобразуем даты в UTC
      for (var j = 0; j < all_data.length; ++j) {
        for (var i = 0; i < all_data[j].data.length; ++i) {
          all_data[j].data[i][0] = Date.parse(all_data[j].data[i][0]);
       }
      }
      // свойства графика
      var plot_conf = {
       series: {
         lines: { 
           show: true,
           lineWidth: 2 
         }
       },
       xaxis: {
         mode: "time",
         timeformat: "%y/%m/%d",
       }
      };

      $.plot("#placeholder", all_data, plot_conf);
    }
  });
});
/*]]>*/
</script>
</div>
</body>
</html>